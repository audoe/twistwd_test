# HG changeset patch
# Parent 30d055aa2ac716e4bd06a03cb26f1e229871f601
The recent adding of ".manifest" files to SHIP_BINS is to support properly
running js.exe on Windows with a vc8 build. The .manifest file needs to
be next to js.exe in the dist/bin dir to properly load the MSVCR80.dll
dependency. Note that a vc6 build wouldn't build the .manifest files
so this addition to the patch isn't perfect.



diff --git a/js/src/jsconfig.mk b/js/src/jsconfig.mk
--- a/js/src/jsconfig.mk
+++ b/js/src/jsconfig.mk
@@ -43,6 +43,10 @@ ifndef OBJDIR
   endif
 endif
 
+ifndef MOZ_OBJDIR
+MOZ_OBJDIR = $(MOZ_DEPTH)
+endif
+
 NSPR_VERSION = v4.0
 NSPR_LIBSUFFIX = 4
 
@@ -104,24 +108,27 @@ else
 	echo $(NSPR_VERSION) > $(NSPR_VERSIONFILE)
 endif
 
+ifndef SHIP_DIST
 SHIP_DIST  = $(MOZ_DEPTH)/dist/$(OBJDIR)
+endif
+ifndef SHIP_DIR
 SHIP_DIR   = $(SHIP_DIST)/SHIP
+endif
 
 SHIP_LIBS      = libjs.$(SO_SUFFIX) libjs.a
 ifeq ($(OS_ARCH), WINNT)
   SHIP_LIBS    = js32.dll js32.lib
 endif
-SHIP_LIBS     += $(LCJAR)
-SHIP_LIBS     := $(addprefix $(SHIP_DIST)/lib/, $(SHIP_LIBS))
+SHIP_LIBS     := $(addprefix $(OBJDIR), $(SHIP_LIBS))
 
 SHIP_INCS      = js*.h prmjtime.h resource.h *.msg *.tbl
-SHIP_INCS     := $(addprefix $(SHIP_DIST)/include/, $(SHIP_INCS))
+SHIP_INCS     := $(addprefix ./, $(SHIP_INCS))
 
 SHIP_BINS      = js
 ifeq ($(OS_ARCH), WINNT)
-  SHIP_BINS   := $(addsuffix .exe, $(SHIP_BINS))
+  SHIP_BINS   := $(addsuffix .exe, $(SHIP_BINS)) js.exe.manifest js32.dll js32.dll.manifest
 endif
-SHIP_BINS     := $(addprefix $(SHIP_DIST)/bin/, $(SHIP_BINS))
+SHIP_BINS     := $(addprefix $(OBJDIR)/, $(SHIP_BINS))
 
 ifdef BUILD_OPT
   JSREFJAR = jsref_opt.jar
@@ -146,6 +153,16 @@ ifdef BUILD_SHIP
 	cp $(SHIP_DIR)/$(JSREFJAR) $(BUILD_SHIP)
 endif
 
+dist:
+	mkdir -p $(MOZ_OBJDIR)/dist/lib/js
+	mkdir -p $(MOZ_OBJDIR)/dist/include/js
+	cp $(SHIP_BINS) $(MOZ_OBJDIR)/dist/bin
+	cp $(SHIP_LIBS) $(MOZ_OBJDIR)/dist/lib/js
+	cp $(SHIP_INCS) $(MOZ_OBJDIR)/dist/include/js
+
+distbin:
+	cp $(SHIP_BINS) $(MOZ_OBJDIR)/dist/bin
+
 CWD = $(shell pwd)
 shipSource: $(SHIP_DIR)/jsref_src.lst .FORCE
 	mkdir -p $(SHIP_DIR)
